# Minimal FreeRADIUS configuration for basic testing
# This is as simple as possible to get authentication working

# Basic server configuration
prefix = /etc/freeradius
exec_prefix = ${prefix}
sysconfdir = ${prefix}
localstatedir = /var
sbindir = ${exec_prefix}/sbin
logdir = /var/log/radius
raddbdir = ${sysconfdir}/freeradius
radacctdir = ${logdir}/radacct
modconfdir = ${raddbdir}/mods-config

# Process and security
name = freeradius
confdir = ${raddbdir}
run_dir = /var/run/freeradius
db_dir = /var/lib/freeradius
libdir = /usr/lib/freeradius
pidfile = ${run_dir}/${name}.pid
max_request_time = 30
cleanup_delay = 5
max_requests = 16384

# Logging
log {
    destination = stdout
    colourise = yes
    file = ${logdir}/radius.log
    syslog_facility = daemon
    stripped_names = no
    auth = yes
    auth_badpass = yes 
    auth_goodpass = yes
    msg_denied = "You are already logged in - access denied"
}

# Security
security {
    allow_core_dumps = no
    max_attributes = 200
    reject_delay = 1
    status_server = yes
}

# Include clients
$INCLUDE clients.conf

# Load modules
modules {
    # Basic PAP module
    pap {
        normalise = yes
    }
    
    # Files module for user authentication
    files {
        usersfile = ${confdir}/users
        acctusersfile = ${confdir}/acct_users
        preproxy_usersfile = ${confdir}/preproxy_users
    }
    
    # Always modules for flow control
    always reject {
        rcode = reject
    }
    always ok {
        rcode = ok
    }
    always noop {
        rcode = noop
    }
    
    # Detail for accounting
    detail {
        filename = ${radacctdir}/%{%{Packet-Src-IP-Address}:-%{Packet-Src-IPv6-Address}}/detail-%Y%m%d
        header = "%t"
        permissions = 0600
        locking = no
        escape_filenames = no
        log_packet_header = no
    }
    
    # Basic processing modules
    preprocess {
    }
    
    # REST module for API-based authentication
    rest {
        tls {
            check_cert = no
            check_cert_cn = no
        }
        
        connect_uri = "${ENV_HEIMDALL_API_URL}"
        
        pool {
            start = 2
            min = 1
            max = 10
            spare = 1
            uses = 0
            lifetime = 0
            cleanup_interval = 30s
            idle_timeout = 60s
            retry_delay = 30s
            spread = no
        }
        
        authenticate {
            uri = "${..connect_uri}/api/radius/authenticate"
            method = 'post'
            body = 'post'
            data = '{"username": "%{User-Name}", "password": "%{User-Password}", "nas_ip": "%{NAS-IP-Address}", "calling_station_id": "%{Calling-Station-Id}"}'
        }
    }
}

# Instantiate modules
instantiate {
    pap
    files
    reject
    ok
    noop
    detail
    preprocess
    rest
}

# Main virtual server
server default {
    listen {
        type = auth
        ipaddr = *
        port = 1812
        limit {
            max_connections = 16
            lifetime = 0
            idle_timeout = 30
        }
    }

    listen {
        type = acct
        ipaddr = *
        port = 1813
        limit {
            max_connections = 16
            lifetime = 0
            idle_timeout = 30
        }
    }

    authorize {
        # Simple file-based authorization for testing
        preprocess
        files
        pap
    }

    authenticate {
        Auth-Type PAP {
            # PAP authentication using files
            pap
        }
        
        Auth-Type REST {
            # REST API authentication via Heimdall
            rest
        }
    }

    preacct {
        preprocess
        files
    }

    accounting {
        detail
    }

    post-auth {
        # Log successful authentications
        noop
    }
}
