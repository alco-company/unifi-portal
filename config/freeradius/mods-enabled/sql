# -*- text -*-
##
## SQL module configuration for Heimdall MySQL integration
## Fixed configuration with hardcoded values for Alpine FreeRADIUS
##

sql {
    # Database driver
    driver = "rlm_sql_mysql"
    
    # Database connection info  
    dialect = "mysql"
    
    # Connection parameters - hardcoded for reliability
    server = "heimdall-db"
    port = 3306
    login = "heimdall"
    password = "U2FsdGVkX19fY2F0YWxvZ2luX3Bhc3N!!Jk"
    
    # Database name
    radius_db = "freeradius"
    
    # Connection pool configuration
    pool {
        start = 5
        min = 5
        max = 10
        spare = 3
        uses = 0
        retry_delay = 30
        lifetime = 0
        idle_timeout = 60
    }

    # SQL queries with hardcoded database name
    
    # User authentication query
    authorize_check_query = "SELECT id, username, attribute, value, op FROM freeradius.radcheck WHERE username = '%{SQL-User-Name}' ORDER BY id"
    
    # User reply attributes query  
    authorize_reply_query = "SELECT id, username, attribute, value, op FROM freeradius.radreply WHERE username = '%{SQL-User-Name}' ORDER BY id"
    
    # Group check query
    authorize_group_check_query = "SELECT id, groupname, attribute, value, op FROM freeradius.radgroupcheck WHERE groupname = '%{Sql-Group}' ORDER BY id"
    
    # Group reply query
    authorize_group_reply_query = "SELECT id, groupname, attribute, value, op FROM freeradius.radgroupreply WHERE groupname = '%{Sql-Group}' ORDER BY id"
    
    # User group membership query
    group_membership_query = "SELECT groupname FROM freeradius.radusergroup WHERE username='%{SQL-User-Name}' ORDER BY priority"
    
    # Accounting queries
    accounting_onoff_query = "UPDATE freeradius.radacct SET acctstoptime = NOW(), acctsessiontime = unix_timestamp(now()) - unix_timestamp(acctstarttime), acctterminatecause = '%{Acct-Terminate-Cause}', acctstopdelay = %{%{Acct-Delay-Time}:-0} WHERE acctstoptime IS NULL AND nasipaddress = '%{NAS-IP-Address}' AND username = '%{SQL-User-Name}'"
    
    accounting_update_query = "UPDATE freeradius.radacct SET framedipaddress = '%{Framed-IP-Address}', acctsessiontime = '%{Acct-Session-Time}', acctinputoctets = '%{Acct-Input-Octets}', acctoutputoctets = '%{Acct-Output-Octets}' WHERE acctsessionid = '%{Acct-Session-Id}' AND username = '%{SQL-User-Name}' AND nasipaddress = '%{NAS-IP-Address}'"
    
    accounting_start_query = "INSERT INTO freeradius.radacct (acctsessionid, acctuniqueid, username, nasipaddress, nasportid, nasporttype, acctstarttime, acctupdatetime, acctstoptime, acctsessiontime, acctauthentic, connectinfo_start, connectinfo_stop, acctinputoctets, acctoutputoctets, calledstationid, callingstationid, acctterminatecause, servicetype, framedprotocol, framedipaddress) VALUES ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', '%{SQL-User-Name}', '%{NAS-IP-Address}', '%{NAS-Port}', '%{NAS-Port-Type}', NOW(), NOW(), NULL, '0', '%{Acct-Authentic}', '%{Connect-Info}', '', '0', '0', '%{Called-Station-Id}', '%{Calling-Station-Id}', '', '%{Service-Type}', '%{Framed-Protocol}', '%{Framed-IP-Address}')"
    
    accounting_stop_query = "UPDATE freeradius.radacct SET acctstoptime = NOW(), acctsessiontime = '%{Acct-Session-Time}', acctinputoctets = '%{Acct-Input-Octets}', acctoutputoctets = '%{Acct-Output-Octets}', acctterminatecause = '%{Acct-Terminate-Cause}', acctstopdelay = %{%{Acct-Delay-Time}:-0}, connectinfo_stop = '%{Connect-Info}' WHERE acctsessionid = '%{Acct-Session-Id}' AND username = '%{SQL-User-Name}' AND nasipaddress = '%{NAS-IP-Address}'"
    
    # Set to 'yes' to read radius clients from the database ('nas' table)
    read_clients = yes
    client_table = "nas"
    
    # Client table schema mapping for Heimdall's 'nas' table
    client_query = "SELECT id, nasname, shortname, secret, nas_type as type, server, community, description FROM freeradius.nas"
    
    # Logfile for SQL errors
    logfile = /var/log/freeradius/sqllog.sql
    
    # Accounting tables
    acct_table1 = "radacct"
    acct_table2 = "radacct"
    
    # Allow for storing data after authentication
    postauth_table = "radpostauth"
    postauth_query = "INSERT INTO freeradius.radpostauth (username, pass, reply, authdate) VALUES ('%{User-Name}', '%{%{User-Password}:-%{Chap-Password}}', '%{reply:Packet-Type}', NOW())"
}
